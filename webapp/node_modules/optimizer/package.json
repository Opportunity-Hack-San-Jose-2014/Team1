{
  "name": "optimizer",
  "description": "Module to support the optimized delivery of web application resources",
  "repository": {
    "type": "git",
    "url": "https://github.com/raptorjs/optimizer.git"
  },
  "scripts": {
    "test": "rm -rf .cache && node_modules/.bin/mocha --ui bdd --reporter spec ./test && node_modules/.bin/mocha --ui bdd --reporter spec ./test && node_modules/.bin/jshint lib/ taglib/"
  },
  "author": {
    "name": "Patrick Steele-Idem",
    "email": "pnidem@gmail.com"
  },
  "maintainers": "Patrick Steele-Idem <pnidem@gmail.com>",
  "dependencies": {
    "app-module-path": "^1.0.0",
    "app-root-dir": "^1.0.0",
    "async": "^0.9.0",
    "browser-refresh-client": "^1.0.0",
    "glob": "^4.0.6",
    "jsonminify": "~0.2.3",
    "mime": "~1.2.7",
    "mkdirp": "^0.5.0",
    "optimizer-minify-css": "^1.0.0",
    "optimizer-minify-js": "^1.0.0",
    "optimizer-require": "^1.0.0",
    "optimizer-resolve-css-urls": "^1.0.0",
    "property-handlers": "^1.0.0",
    "raptor-async": "^1.0.0",
    "raptor-cache": "^1.1.1",
    "raptor-detect": "^1.0.0",
    "raptor-dust": "^1.1.2",
    "raptor-logging": "^1.0.1",
    "raptor-modules": "^1.0.5",
    "raptor-objects": "^1.0.1",
    "raptor-polyfill": "^1.0.0",
    "raptor-promises": "^1.0.1",
    "raptor-regexp": "^1.0.0",
    "raptor-strings": "^1.0.0",
    "raptor-util": "^1.0.0",
    "through": "^2.3.4"
  },
  "devDependencies": {
    "chai": "~1.8.1",
    "dustjs-linkedin": "^2.4.0",
    "jshint": "~2.3.0",
    "mocha": "~1.15.1",
    "fs-extra": "~0.12.0",
    "optimizer-dust": "^1.0.0",
    "optimizer-marko": "^1.0.0",
    "marko": "^1.1.24",
    "deamdify": "^0.1.1"
  },
  "license": "Apache License v2.0",
  "main": "lib/optimizer.js",
  "publishConfig": {
    "registry": "https://registry.npmjs.org/"
  },
  "keywords": [
    "bundler",
    "build",
    "css",
    "javascript",
    "concat",
    "minify"
  ],
  "version": "1.7.0",
  "readme": "RaptorJS Optimizer\n==================\n\n[![Build Status](https://travis-ci.org/raptorjs/optimizer.svg?branch=master)](https://travis-ci.org/raptorjs/optimizer) [![Gitter](https://badges.gitter.im/Join Chat.svg)](https://gitter.im/raptorjs/optimizer?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge&utm_content=badge)\n\nThe RaptorJS Optimizer is a Node.js-style JavaScript module bundler that also provides first-level support for optimally delivering JavaScript, CSS, images and other assets to the browser.\n\nThis tool offers many different optimizations such as a bundling, code splitting, lazy loading, conditional dependencies, compression and fingerprinted resource URLs. Plugins are provided to support pre-processors and compilers such as Less, Stylus and [Marko](https://github.com/raptorjs/marko). This developer-friendly tool does not require that you change the way that you already code and can easily be adopted by existing applications.\n\n![eBay Open Source](https://raw.githubusercontent.com/raptorjs/optimizer/master/images/ebay.png)\n\n<!-- START doctoc generated TOC please keep comment here to allow auto update -->\n<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->\n\n# Table of Contents\n\n- [Example](#example)\n- [Design Philosophy](#design-philosophy)\n- [Features](#features)\n- [Another Client-side Bundler?](#another-client-side-bundler)\n- [Installation](#installation)\n- [Usage](#usage)\n\t- [Command Line Interface](#command-line-interface)\n\t- [JSON Configuration File](#json-configuration-file)\n\t- [Dependencies](#dependencies)\n\t\t- [Conditional Dependencies](#conditional-dependencies)\n\t\t- [Enabling Flags](#enabling-flags)\n\t- [Asynchronous/Lazy Loading](#asynchronouslazy-loading)\n\t- [JavaScript API](#javascript-api)\n\t\t- [Configuring the Default Page Optimizer](#configuring-the-default-page-optimizer)\n\t\t- [Optimizing a Page](#optimizing-a-page)\n\t\t- [Creating a New Page Optimizer](#creating-a-new-page-optimizer)\n\t- [Optimizer Taglib](#optimizer-taglib)\n\t\t- [Using the Optimizer Taglib with Marko](#using-the-optimizer-taglib-with-marko)\n\t\t- [Using the Optimizer Taglib with Dust](#using-the-optimizer-taglib-with-dust)\n\t- [Client/Server Template Rendering](#clientserver-template-rendering)\n\t- [Runtime Optimization with Express](#runtime-optimization-with-express)\n\t- [Bundling](#bundling)\n\t- [Code Splitting](#code-splitting)\n- [Configuration](#configuration)\n\t- [Default Configuration](#default-configuration)\n\t- [Complete Configuration](#complete-configuration)\n- [Node.js-style Module Support](#nodejs-style-module-support)\n- [Available Plugins](#available-plugins)\n- [Extending the Optimizer](#extending-the-optimizer)\n\t- [Custom Plugins](#custom-plugins)\n\t- [Custom Dependency Types](#custom-dependency-types)\n\t\t- [Custom JavaScript Dependency Type](#custom-javascript-dependency-type)\n\t\t- [Custom CSS Dependency Type](#custom-css-dependency-type)\n\t\t- [Custom Package Type](#custom-package-type)\n\t- [Custom Output Transforms](#custom-output-transforms)\n- [Sample Projects](#sample-projects)\n- [Discuss](#discuss)\n- [Maintainers](#maintainers)\n- [Contributors](#contributors)\n- [Contribute](#contribute)\n- [License](#license)\n\n<!-- END doctoc generated TOC please keep comment here to allow auto update -->\n\n# Example\n\nInstall the command line interface for the Optimizer:\n\n```text\nnpm install optimizer-cli --global\n```\n\nInstall a helper module from npm:\n\n```text\nnpm install change-case\n```\n\nCreate the main Node.js JavaScript module file:\n\n__main.js:__\n\n```javascript\nvar changeCase = require('change-case');\nconsole.log(changeCase.titleCase('hello world')); // Output: 'Hello World'\n```\n\nCreate a StyleSheet for the page:\n\n__style.css__\n\n```css\nbody {\n    background-color: #5B83AD;\n}\n```\n\nCreate an HTML page to host the application:\n\n__my-page.html:__\n\n```html\n<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Optimizer Demo</title>\n</head>\n<body>\n    <h1>Optimizer Demo</h1>\n</body>\n</html>\n```\n\nRun the following command:\n\n```bash\noptimizer style.css \\\n    --main main.js \\\n    --inject-into my-page.html\n```\n\nOutput:\n\n```text\nOutput for page \"my-page\":\n  Resource bundle files:\n    static/my-page-9ac9985e.js\n    static/my-page-1ae3e9bf.css\n  HTML slots file:\n    build/my-page.html.json\n  Updated HTML file:\n    my-page.html\n```\n\nOpen up `my-page.html` in your web browser and in the JavaScript console you will see the output of our program running in the browser, as well as a page styled by `style.css`.\n\nAs you can see, with the Optimizer you no longer have to struggle with managing complex build scripts. Simply let the Optimizer worry about generating all of the required optimized resource bundles and injecting them into your page so that you can just focus on writing clean and modular code.\n\nThere's also a JavaScript API, taglib and a collection of plugins to make your job as a front-end web developer easier. Please read on to learn how you can easily utilize the Optimizer in your application.\n\n# Design Philosophy\n\n* Dependencies should be **declarative** _or_ discovered via **static code analysis**\n* Common **module loading** patterns should be supported\n* Must be **extensible** to support all types of resources\n* **Maximize productivity** in development\n* **Maximize performance** in production\n* Must be **easy to adopt** and not change how you write your code\n* Can be used at **runtime or build time**\n* Must be **configurable**\n\n# Features\n\n* Optimize Client-side Dependencies\n    * Supports all types of front-end resources (JavaScript, CSS, images, Less, CoffeeScript, etc.)\n    * Configurable resource bundling\n    * Code splitting\n    * JavaScript minification\n    * CSS minification\n    * [Fingerprinted](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching) resource URLs\n    * Prefix resources with CDN host name\n    * Optional Base64 image encoding inside CSS files\n    * Custom output transforms\n    * Declarative browser-side package dependencies using simple `optimizer.json` files\n    * Generates the HTML markup required to include optimized resources\n\t* Conditional dependencies\n\t* Image minification\n    * etc.\n* Browser-side Node.js Module Loader\n    * Full support for [Isomorphic JavaScript](http://nerds.airbnb.com/isomorphic-javascript-future-web-apps/)\n    * Conflict-free CommonJS module loader for the browser\n    * Complete compatibility with Node.js\n        * Supports `module.exports`, `exports`, `require`, `require.resolve`, `__dirname`, `__filename`, `process`, etc.\n    * Supports the [package.json `browser` field](https://gist.github.com/defunctzombie/4339901)\n    * Full support for [browserify](http://browserify.org/) shims and transforms\n    * Maintains line numbers in wrapped code\n* Developer Friendly\n    * Disable bundling and minification in development\n    * Line numbers are maintained for Node.js modules source\n    * Extremely fast _incremental builds_!\n        * Only modified bundles are written to disk\n        * Disk caches are utilized to avoid repeating the same work\n* Dependency Compilation\n    * Less\n    * [Marko](https://github.com/raptorjs/marko)\n    * Dust\n    * etc.\n* Extensible\n    * Custom dependency compilers\n    * Custom code transforms\n    * Custom bundle writers\n    * Custom plugins\n* Configurable\n    * Configurable resource bundles\n    * Enable/disable transforms\n    * Development-mode versus production-mode\n    * Enable/disable fingerprints\n    * etc.\n* Flexible\n    * Integrate with build tools\n    * Use with Express or any other web development framework\n    * JavaScript API, CLI and taglib\n* _Future_\n    * Automatic image sprites\n\n# Another Client-side Bundler?\n\n[Browserify](http://browserify.org/) is an excellent JavaScript module bundler. We are huge supporters of writing Node.js-style modules (i.e. CommonJS), and we also believe [npm](https://www.npmjs.org/) is an excellent package manager. If you are not using a JavaScript module bundler then you are absolutely missing out. Modularity is equally important for client-side code as it is for server-side code, and a JavaScript module bundler should be part of every front-end developer's toolbox.\n\nSo why did we create the RaptorJS Optimizer if Browserify is such a great tool? We created the RaptorJS Optimizer because we wanted a top-notch JavaScript module bundler that _also_ provides first-level support for transporting CSS, \"plain\" JavaScript, images, fonts and other front-end assets to the browser in the most optimal way. In addition, we want to enable developers to easily create web applications that follow [widely accepted rules for creating faster-loading websites](http://stevesouders.com/examples/rules.php) (such as putting StyleSheets at the top, and JavaScript at the bottom). We also want to allow for developers to easily load additional JavaScript and StyleSheets after the initial page load.\n\nWhile high performance is very important for production systems, we want to also provide a more developer-friendly experience by offering fast, incremental builds, simplifying development and by producing debuggable output code. And, of course, we do not want developers to have to learn how to code their applications in a new way so the RaptorJS Optimizer was built to not change how you already code. You'll even find support for Browserify shims and transforms. Therefore, if you try out the RaptorJS Optimizer and it is not the tool for you, then feel free to switch back to something else (it'll of course be ready if your application's requirements change in the future). eBay and other large companies rely on the RaptorJS Optimizer for delivering high performance websites and are committed to its success. If you try it out and find gaps, please let us know!\n\n# Installation\n\nThe following command should be used to install the `optimizer` module into your project:\n\n```bash\nnpm install optimizer --save\n```\n\nIf you would like to use the available command line interface, then you should install the [optimizer-cli](https://github.com/raptorjs/optimizer-cli) module globally using the following command:\n\n```bash\nnpm install optimizer-cli --global\n```\n\n# Usage\n\n## Command Line Interface\n\n<hr>\n\n[__Sample App:__](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-cli) To try out and experiment with the code, please see the following project:<br>[raptor-samples/optimizer-cli](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-cli)\n\n<hr>\n\nInstall the command line interface for the Optimizer:\n\n```bash\nnpm install optimizer-cli --global\n```\n\nIn an empty directory, initialize a new Node.js project using the following command:\n\n```bash\nmkdir my-app\ncd my-app\nnpm init\n```\n\nInstall required modules into the new project:\n\n```bash\nnpm install jquery\nnpm install optimizer-less\n```\n\nCreate the following files:\n\n__add.js:__\n\n```javascript\nmodule.exports = function(a, b) {\n    return a + b;\n};\n```\n\n__main.js:__\n\n```javascript\nvar add = require('./add');\nvar jquery = require('jquery');\n\njquery(function() {\n    $(document.body).append('2+2=' + add(2, 2));\n});\n```\n\n__style.less:__\n\n```css\n@headerColor: #5B83AD;\n\nh1 {\n    color: @headerColor;\n}\n```\n\n__my-page.html:__\n\n```html\n<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Optimizer Demo</title>\n</head>\n<body>\n    <h1>Optimizer Demo</h1>\n</body>\n</html>\n```\n\nFinally, run the following command to generate the optimized resource bundles for the page and to also inject the required `<script>` and `<link>` tags into the HTML page:\n\n```bash\noptimizer style.less \\\n    --main main.js \\\n    --inject-into my-page.html \\\n    --plugins optimizer-less \\\n    --development\n```\n\nIf everything worked correctly then you should see output similar to the following:\n\n```text\nOutput for page \"my-page\":\n  Resource bundle files:\n    static/add.js\n    static/raptor-modules-meta.js\n    static/main.js\n    static/node_modules/jquery/dist/jquery.js\n    static/raptor-modules-1.0.1/client/lib/raptor-modules-client.js\n    static/style.less.css\n  HTML slots file:\n    build/my-page.html.json\n  Updated HTML file:\n    my-page.html\n```\n\nThe updated `my-page.html` file should be similar to the following:\n\n```html\n<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Optimizer Demo</title>\n    <!-- <optimizer-head> -->\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"static/style.less.css\">\n    <!-- </optimizer-head> -->\n</head>\n<body>\n    <h1>Optimizer Demo</h1>\n    <!-- <optimizer-body> -->\n    <script type=\"text/javascript\" src=\"static/raptor-modules-1.0.1/client/lib/raptor-modules-client.js\"></script>\n    <script type=\"text/javascript\" src=\"static/add.js\"></script>\n    <script type=\"text/javascript\" src=\"static/raptor-modules-meta.js\"></script>\n    <script type=\"text/javascript\" src=\"static/node_modules/jquery/dist/jquery.js\"></script>\n    <script type=\"text/javascript\" src=\"static/main.js\"></script>\n    <script type=\"text/javascript\">$rmod.ready();</script>\n    <!-- </optimizer-body> -->\n</body>\n</html>\n```\n\nIf you open up `my-page.html` in your web browser you should see a page styled with Less and the output of running `main.js`.\n\nNow try again with `production` mode:\n\n```bash\noptimizer style.less \\\n    --main main.js \\\n    --inject-into my-page.html \\\n    --plugins optimizer-less \\\n    --production\n```\n\n```\nOutput for page \"my-page\":\n  Resource bundle files:\n    static/my-page-2e3e9936.js\n    static/my-page-169ab5d9.css\n  HTML slots file:\n    build/my-page.html.json\n  Updated HTML file:\n    my-page.html\n```\n\nThe updated `my-page.html` file should be similar to the following:\n\n```html\n<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Optimizer Demo</title>\n    <!-- <optimizer-head> -->\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"static/my-page-169ab5d9.css\">\n    <!-- </optimizer-head> -->\n</head>\n<body>\n    <h1>Optimizer Demo</h1>\n    <!-- <optimizer-body> -->\n    <script type=\"text/javascript\" src=\"static/my-page-2e3e9936.js\"></script>\n    <script type=\"text/javascript\">$rmod.ready();</script>\n    <!-- </optimizer-body> -->\n</body>\n</html>\n```\n\nWith the `--production` option enabled, all of the resources are concatenated together, minified and fingerprinted – perfect for high performance web applications running in production.\n\nFor more documentation on the Command Line Interface please see the [optimizer-cli docs](https://github.com/raptorjs/optimizer-cli).\n\n## JSON Configuration File\n\n<hr>\n\n[__Sample App__](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-config) To try out and experiment with the code, please see the following project:<br>[raptor-samples/optimizer-config](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-config)\n\n<hr>\n\nThe number of command line arguments can get unwieldy so it is better to split out configuration into a separate JSON file. Let's now create a configuration file and configure a few bundles to make things more interesting:\n\n__optimizer-config.json:__\n\n```json\n{\n\n    \"plugins\": [\n        \"optimizer-less\"\n    ],\n    \"outputDir\": \"static\",\n\t\"fingerprintsEnabled\": true,\n    \"minify\": true,\n    \"resolveCssUrls\": true,\n    \"bundlingEnabled\": true,\n    \"bundles\": [\n        {\n            \"name\": \"jquery\",\n            \"dependencies\": [\n                \"require: jquery\"\n            ]\n        },\n        {\n            \"name\": \"math\",\n            \"dependencies\": [\n                \"require: ./add\"\n            ]\n        }\n    ]\n}\n```\n\nIn addition, let's put our page dependencies in their own JSON file:\n\n__my-page.optimizer.json:__\n\n```json\n{\n    \"dependencies\": [\n        \"./style.less\",\n        \"require-run: ./main\"\n    ]\n}\n```\n\nNow run the page optimizer using the newly created JSON config file and JSON dependencies file:\n\n```bash\noptimizer ./my-page.optimizer.json \\\n    --inject-into my-page.html \\\n    --config optimizer-config.json\n```\n\nBecause of the newly configured bundles, we'll see additional JavaScript bundles written to disk as shown below:\n\n```\nOutput for page \"my-page\":\n  Resource bundle files:\n    static/math-169c956d.js\n    static/jquery-24db89d9.js\n    static/my-page-beed0921.js\n    static/my-page-169ab5d9.css\n  HTML slots file:\n    build/my-page.html.json\n  Updated HTML file:\n    my-page.html\n```\n\n## Dependencies\n\nTo optimize a page the Optimizer walks a dependency graph. A dependency can either be a JavaScript or CSS resource (or a file that compiles to either JavaScript or CSS) or a dependency can be a reference to a set of transitive dependencies. Some dependencies are inferred from scanning source code and other dependencies can be made explicit by listing them out in the code of JavaScript modules or in separate `optimizer.json` files.\n\nIt's also possible to register your own [custom dependency types](#custom-dependency-types). With custom dependency types, you can control how resources are compiled or a custom dependency type can be used to resolve additional dependencies during optimization.\n\nA dependency can be described using a simple `String` path as shown in the following code:\n\n```json\n[\n    \"./style.less\",\n    \"../third-party/jquery.js\",\n    \"**/*.css\"\n]\n```\n\nIn the examples, the dependency type is inferred from the filename extension. Alternatively, the dependency type can be made explicit using either one of the following formats:\n\n```json\n[\n    \"./style.less\",\n    \"less: ./style.less\",\n    { \"type\": \"less\", \"path\": \"./style.less\" }\n]\n```\n\n_NOTE: all of the above are equivalent_\n\nYou can also create a dependency that references dependencies in a separate `optimizer.json` file. Dependencies that have the `optimizer.json` extension are automatically resolved using the require resolver if they are not relative paths. For example:\n```js\n[\n    // Relative path:\n    \"./some-module/optimizer.json\",\n\n    // Look for \"my-module/optimizer.json\" in \"node_modules\":\n    \"my-module/optimizer.json\"\n]\n```\n\nIf the path does not have a file extension then it is assumed to be a path to an `optimizer.json` file so the following short-hand works as well:\n```js\n[\n    \"./some-module\"\n    \"my-module\"\n]\n```\nIf you use the short-hand notation for `optimizer.json` dependencies, the paths will still be resolved using the require resolver as long as they are not relative paths.\n\n### Conditional Dependencies\n\nThe Optimizer supports conditional dependencies. Conditional dependencies is a powerful feature that allows for a page to be optimized differently based on certain flags (e.g. \"mobile device\" versus \"desktop\"). For caching reasons, the flags for conditional dependencies should be based on a set of enabled flag. A flag is just an arbitrary name that can be enabled/disabled before optimizing a page. For example, to make a dependency conditional such that is only included for mobile devices you can do the following:\n\n```json\n{\n    \"dependencies\": [\n        { \"path\": \"./hello-mobile.js\", \"if-flag\": \"mobile\" }\n    ]\n}\n```\n\nAlternatively, you can also include the desktop version of a file if the \"mobile\" extension is not enabled.\n```json\n{\n    \"dependencies\": [\n        { \"path\": \"./hello-desktop.js\", \"if-not-flag\": \"mobile\" }\n    ]\n}\n```\n\nIf needed, a JavaScript expression can be used to describe a more complex condition as shown in the following sample code:\n\n```json\n{\n    \"dependencies\": [\n        {\n            \"path\": \"./hello-mobile.js\",\n            \"if\": \"flags.contains('phone') || flags.contains('tablet')\"\n        }\n    ]\n}\n```\n\n### Enabling Flags\n\nThe code below shows how to enable flags when optimizing a page:\n\n__Using the JavaScript API:__\n\n```javascript\npageOptimizer.optimizePage({\n    dependencies: [\n        { path: './hello-mobile.js', 'if-flag': 'mobile' }\n    ],\n    flags: ['mobile', 'foo', 'bar']\n})\n```\n\n__Using the Marko taglib:__\n\n```html\n<optimize-page ... flags=\"['mobile', 'foo', 'bar']\">\n    ...\n</optimize-page>\n```\n\n## Asynchronous/Lazy Loading\n\n<hr>\n\n[__Sample App__](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-async)To try out and experiment with the code, please see the following project:<br>[raptor-samples/optimizer-async](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-async)\n\n<hr>\n\n\nThe Optimizer supports asynchronously loading dependencies using the lightweight [raptor-loader](https://github.com/raptorjs/raptor-loader/blob/master/lib/raptor-loader.js) module as shown in the following sample code:\n\n```javascript\nvar raptorLoader = require('raptor-loader');\n\nraptorLoader.async(function(err) {\n    // Any modules that are required within the scope\n    // of this function will be loaded asynchronously*.\n    // The Optimizer ensures that modules are only\n    // loaded once from the server.\n    //\n    // *Modules that were included as part of the initial\n    // page load will automatically be de-duped.\n\n    if (err) {\n        // Handle the case where one or more of the\n        // dependencies failed to load.\n    }\n\n    var add = require('./add');\n    var jquery = require('jquery');\n\n    jquery(function() {\n        $(document.body).append('2+2=' + add(2, 2));\n    });\n});\n```\n\nDuring optimization, the Optimizer detects the call to `require('raptor-loader').async(...)` and transforms the code such that the function is not invoked until all of the required modules referenced in the body of callback function are completely loaded.\n\nYou can also specify additional explicit dependencies if necessary:\n\n```javascript\nrequire('raptor-loader').async(\n    [\n        './style.less',\n        'some/other/optimizer.json'\n    ],\n    function() {\n        // All of the requires nested in this function block will be lazily loaded.\n        // When all of the required resources are loaded then the function will be invoked.\n        var foo = require('foo');\n        var bar = require('bar');\n    });\n```\n\nYou can also choose to declare async dependencies in an `optimizer.json` file:\n\n```json\n{\n    \"dependencies\": [\n        ...\n    ],\n    \"async\": {\n        \"my-module/lazy\": [\n            \"require: foo\",\n            \"require: bar\",\n            \"./style.less\",\n            \"some/other/optimizer.json\"\n        ]\n    }\n}\n```\n\nThe async dependencies can then be referenced in code:\n```javascript\nrequire('raptor-loader').async(\n    'my-module/lazy',\n    function() {\n        var foo = require('foo');\n        var bar = require('bar');\n    });\n```\n\n## JavaScript API\n\n<hr>\n\n[__Sample App__](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-js-api) To try out and experiment with the code, please see the following project:<br>[raptor-samples/optimizer-js-api](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-js-api)\n\n<hr>\n\nFor added flexibility there is a JavaScript API that can be used to optimize pages as shown in the following sample code:\n\n```javascript\nvar optimizer = require('optimizer');\noptimizer.configure('optimizer-config.json');\noptimizer.optimizePage({\n        name: 'my-page',\n        dependencies: [\n            \"./style.less\",\n            \"require-run: ./main\"\n        ]\n    },\n    function(err, optimizedPage) {\n        if (err) {\n            // Handle the error\n        }\n\n        var headHtml = optimizedPage.getHeadHtml();\n        // headHtml will contain something similar to the following:\n        // <link rel=\"stylesheet\" type=\"text/css\" href=\"static/my-page-169ab5d9.css\">\n\n        var bodyHtml = optimizedPage.getBodyHtml();\n        // bodyHtml will contain something similar to the following:\n        //  <script type=\"text/javascript\" src=\"static/my-page-2e3e9936.js\"></script>\n    });\n```\n\nThe `optimizerPage(options)` method supports the following options:\n\n- `data` (`Object`) - Arbitrary data that can be made available to plugins via `optimizerContext.data`.\n- `cacheKey` (`String`) - A unique String to use for cache reads and writes. Defaults to `name`.\n- `dependencies` (`Array`) - An array of top-level page dependencies (e.g. `['foo.js', 'foo.css', 'require: jquery']`).\n- `flags` (`Array`) - The set of enabled flags (e.g. `['mobile', 'touch']`).\n- `from` (`String`) - The base path for resolving relative paths for top-level dependencies.\n- `name` (`String`) - The page name. Used for determining the names of the output JS/CSS bundles.\n- `packagePath` (`String`) - The path to an `optimizer.json` file that describes the top-level dependencies.\n\n### Configuring the Default Page Optimizer\n```javascript\nvar optimizer = require('optimizer');\noptimizer.configure(config);\n```\n\nIf the value of the `config` argument is a `String` then it is treated as a path to a JSON configuration file.\n\n\n### Optimizing a Page\n\nThe following code illustrates how to optimize a simple set of JavaScript and CSS dependencies using the default configured optimizer:\n\n```javascript\nvar optimizer = require('optimizer');\noptimizer.optimizePage({\n        name: 'my-page',\n        dependencies: [\n            './foo.js',\n            './bar.js',\n            './baz.js',\n            './qux.css'\n        ]\n    },\n    function(err, optimizedPage) {\n        if (err) {\n            console.log('Failed to optimize page: ', err);\n            return;\n        }\n\n        var headHtml = optimizedPage.getHeadHtml();\n        /*\n        String with a value similar to the following:\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"/static/my-page-85e3288e.css\">\n        */\n\n        var bodyHtml = optimizedPage.getBodyHtml();\n        /*\n        String with a value similar to the following:\n        <script type=\"text/javascript\" src=\"/static/bundle1-6df28666.js\"></script>\n        <script type=\"text/javascript\" src=\"/static/bundle2-132d1091.js\"></script>\n        <script type=\"text/javascript\" src=\"/static/my-page-1de22b65.js\"></script>\n        */\n\n        // Inject the generated HTML into the <head> and <body> sections of a page...\n    });\n```\n\n### Creating a New Page Optimizer\n\n```javascript\nvar pageOptimizer = optimizer.create(config);\npageOptimizer.optimizePage(...);\n```\n\n\n## Optimizer Taglib\n\n<hr>\n\n[__Sample App__](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-taglib) To try out and experiment with the code, please see the following project:<br>[raptor-samples/optimizer-taglib](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-taglib)\n\n<hr>\n\nFor the ultimate in usability, a taglib is provided for Marko (and Dust) to automatically optimize a page _and_ inject the required HTML markup to include the optimized JavaScript and CSS bundles.\n\nIf you are using [Marko](https://github.com/raptorjs/marko) or [Dust](https://github.com/linkedin/dustjs) you can utilize the available taglib for the Optimizer to easily optimize page dependencies and embed them into your page.\n\n### Using the Optimizer Taglib with Marko\n\n1. `npm install optimizer --save`\n2. `npm install marko --save`\n\nYou can now add the optimizer tags to your page templates. For example:\n\n```html\n<optimizer-page package-path=\"./optimizer.json\"/>\n\n<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Test Page</title>\n    <optimizer-head/>\n</head>\n<body>\n    <h1>Test Page</h1>\n    <optimizer-body/>\n</body>\n</html>\n```\n\nYou will then need to create an `optimizer.json` in the same directory as your page template. For example:\n\n_optimizer.json_:\n```json\n{\n    \"dependencies\": [\n        \"./jquery.js\",\n        \"./foo.js\",\n        \"./bar.js\",\n        \"./style.less\"\n    ]\n}\n```\n\nUsing Marko and the Optimizer taglib, you can simply render the page using code similar to the following:\n\n```javascript\nvar template = require('marko').load('my-page.marko');\ntemplate.render({}, function(err, html) {\n    // html will include all of the required <link> and <script> tags\n});\n```\n\nThe output of the page rendering will be similar to the following:\n\n```html\n<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Test Page</title>\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/static/my-page-85e3288e.css\">\n</head>\n<body>\n    <h1>Test Page</h1>\n    <script type=\"text/javascript\" src=\"/static/bundle1-6df28666.js\"></script>\n    <script type=\"text/javascript\" src=\"/static/bundle2-132d1091.js\"></script>\n    <script type=\"text/javascript\" src=\"/static/my-page-1de22b65.js\"></script>\n</body>\n</html>\n```\n\nThe optimized result is cached so you can skip the build step!\n\nYou can also configure the default page optimizer used by the optimizer tags:\n\n```javascript\nrequire('optimizer').configure({...});\n```\n\nFor more details, please see following documentation: [Optimizer Taglib for Marko](taglib-marko.md)\n\n### Using the Optimizer Taglib with Dust\n\nYou should follow the same steps as above, except you must install the [dustjs-linkedin](https://www.npmjs.org/package/dustjs-linkedin) module and then use `require('optimizer/dust').registerHelpers(dust)` to register the helpers:\n\nInstall required dependencies:\n\n1. `npm install optimizer --save`\n2. `npm install dustjs-linkedin --save`\n\nRegister the Dust helpers during initialization:\n\n```javascript\nvar dust = require('dustjs-linkedin');\nrequire('optimizer/dust').registerHelpers(dust);\n```\n\nFinally, in your Dust templates you can use the new optimizer helpers as shown below:\n\n```html\n\n{@optimizer-page name=\"my-page\" packagePath=\"./optimizer.json\" /}\n\n<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Test Page</title>\n    {@optimizer-head /}\n</head>\n<body>\n    <h1>Test Page</h1>\n    {@optimizer-body /}\n</body>\n</html>\n```\n\n## Client/Server Template Rendering\n\n<hr>\n\n[__Sample App__](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-templates) To try out and experiment with the code, please see the following project:<br>[raptor-samples/optimizer-templates](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-templates)\n\n<hr>\n\nTo demonstrate rendering of the same template on the server and the client we will start with the following Marko template:\n\n__template.marko__\n\n```html\nHello ${data.name}!\n```\n\n_NOTE: The sample app includes sample code that illustrates how to also render both a Dust template and a Handlebars template on both the client and server._\n\nWe will then create a `main.js` file to render the template to the console:\n\n__main.js:__\n\n```javascript\nvar template = require('marko')\n    .load(require.resolve('./template.marko'));\n\ntemplate.render(\n    {\n        name: 'Frank'\n    },\n    function(err, html) {\n        console.log('Template output: ' + html);\n    });\n```\n\n_NOTE: The reason we use `require.resolve('./template.marko')` instead of `require('template.marko')` is that Node.js does not understand how to load `.marko` modules and the use of the `require.extensions` has been [deprecated](http://nodejs.org/api/globals.html#globals_require_extensions). `require.resolve()` is used to get the resolved path for the template and the [marko](https://github.com/raptorjs/marko) module uses that path to load template into memory._\n\nRunning `node main.js` on the server will produce the following output in the console:\n\n```html\nTemplate output: Hello Frank!\n```\n\nIn order to automatically detect and compile required `*.marko` templates we will need to install the [optimizer-marko](https://github.com/raptorjs/optimizer-marko) plugin using the following command:\n\n```bash\nnpm install optimizer-marko\n```\n\nWe can then optimize the page using the following command:\n\n```bash\noptimizer style.less \\\n    --main main.js \\\n    --inject-into my-page.html \\\n    --plugins optimizer-marko\n```\n\nAfter opening `my-page.html` in your web browser you should then see the same output written to the browser's JavaScript console.\n\n## Runtime Optimization with Express\n\n<hr>\n\n[__Sample App__](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-express) To try out and experiment with the code, please see the following project:<br>[raptor-samples/optimizer-express](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-express)\n\n<hr>\n\nThe Optimizer has a smart caching layer and is fast enough so that it can be used at runtime as part of your server application. The easiest way to use the Optimizer at runtime is to use the taglib and simply render the page template to the response output stream.\n\nThe first time the page renders, the page will be optimized and cached and the output of the optimization will be used to produce the final page HTML. After the first page rendering, the only work that will be done by the Optimizer is a simple cache lookup.\n\nBy default, the Optimizer writes all optimized resource bundles into the `static/` directory at the root of your application. In addition, by default, all resource URLs will be prefixed with `/static`. If resources are to be served up by the local Express server we will need to register the appropriate middleware as shown in the following sample code:\n\n__server.js__\n\n```javascript\nvar express = require('express');\nvar compression = require('compression');\nvar serveStatic = require('serve-static');\n\n// Load the page template:\nvar template = require('marko')\n    .load(require.resolve('./template.marko')\n\nvar app = express();\n\n// Enable gzip compression for all HTTP responses:\napp.use(compression());\n\n// Any URL that begins with \"/static\" will be served up\n// out of the \"static/\" directory:\napp.use('/static', serveStatic(__dirname + '/static'));\n\napp.get('/', function(req, res) {\n    // Render the page template as normal:\n    template.render({\n            name: 'Frank'\n        },\n        res);\n});\n...\n\napp.listen(8080);\n```\n\n## Bundling\n\nBy default, all dependencies required for a page will be bundled into a single JavaScript bundle and a single CSS bundle. However, The Optimizer allows application-level bundles to be configured to allow for consistent bundles across pages and for multiple bundles to be included on a single page. Because the Optimizer also generates the HTML markup to include page bundles, the page itself does not need to be changed if the bundle configuration is changed.\n\nIf a page has a dependency that is part of an application-level bundle then the dependency will be included as part of the application-level bundle instead of being aggregated with the page-level bundle.\n\nBundles can be configured using the `\"bundles\"` configuration property that accepts an array of bundle configurations. Each bundle should consist of a name and a set of dependencies to assign to that bundle.\n\n__Bundling Example:__\n\nGiven the following configured bundles:\n\n```json\n{\n    ...\n    \"bundles\": [\n        {\n            \"name\": \"bundle1\",\n            \"dependencies\": [\n                \"./foo.js\",\n                \"./baz.js\"\n            ]\n        },\n        {\n            \"name\": \"bundle2\",\n            \"dependencies\": [\n                \"./bar.js\"\n            ]\n        }\n    ]\n}\n```\n\n\nOptimizing a page that does not include any dependencies in application-level bundles:\n\n```bash\noptimizer app.js style.css --name my-page -c optimizer-config.json\n```\n\nOutput:\n\n```\nOutput for page \"my-page\":\n  Resource bundle files:\n    static/my-page.js\n    static/my-page.css\n  HTML slots file:\n    build/my-page.html.json\n```\n\n\nOptimizing a page that includes \"foo.js\" that is part of \"bundle1\":\n```bash\noptimizer app.js foo.js style.css --name my-page -c optimizer-config.json\n```\n\nOutput:\n\n```\nOutput for page \"my-page\":\n  Resource bundle files:\n    static/my-page.js\n    static/bundle1.js\n    static/my-page.css\n  HTML slots file:\n    build/my-page.html.json\n```\n\nFor more information on working with bundles. Please see the [bundling docs](docs/bundling.md).\n\n## Code Splitting\n\n<hr>\n\n[__Sample App__](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-code-splitting) To try out and experiment with the code, please see the following project:<br>[raptor-samples/optimizer-code-splitting](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-code-splitting)\n\n<hr>\n\nThe Optimizer supports splitting out code that multiple pages/entry points have in common into separate bundles. This is accomplished by assigning an `intersection` dependency to a bundle. The `intersection` dependency is a package dependency that produces a set of dependencies that is the intersection of one or more packages. Code splitting ensures that the same code is not downloaded twice by the user when navigating a web application.\n\nThe following bundle configuration illustrates how to split out common code into a separate bundle:\n\n```json\n{\n    \"bundles\": [\n        {\n            \"name\": \"common\",\n            \"dependencies\": [\n                {\n                    \"intersection\": [\n                        \"./src/pages/home/optimizer.json\",\n                        \"./src/pages/profile/optimizer.json\"\n                    ]\n                }\n            ]\n        }\n    ]\n}\n```\nA less strict intersection condition is also supported via a `threshold` property.\n\nFor example, to find those dependencies that are among *at least two* of the widgets:\n```json\n{\n    \"bundles\": [\n        {\n            \"name\": \"common\",\n            \"dependencies\": [\n                {\n                    \"threshold\": 2,\n                    \"intersection\": [\n                        \"require: ./a/widget\",\n                        \"require: ./b/widget\",\n                        \"require: ./c/widget\"\n                    ]\n                }\n            ]\n        }\n    ]\n}\n```\n\nThis could also be expressed as a percentage:\n```json\n{\n    \"bundles\": [\n        {\n            \"name\": \"common\",\n            \"dependencies\": [\n                {\n                    \"threshold\": \"66%\",\n                    \"intersection\": [\n                        \"require: ./a/widget\",\n                        \"require: ./b/widget\",\n                        \"require: ./c/widget\"\n                    ]\n                }\n            ]\n        }\n    ]\n}\n```\n\n\n# Configuration\n\n## Default Configuration\n```javascript\n{\n    // Write all bundles into the \"static\" directory\n\t\"outputDir\": \"static\",\n\n\t// URL prefix for all bundles\n\t\"urlPrefix\": \"/static\",\n\n\t// Include fingerprint in output files\n\t\"fingerprintsEnabled\": true  \n}\n```\n\n## Complete Configuration\n\n```javascript\n{\n    // Configure Optimizer plugins\n    \"plugins\": [\n        // Plugin with a default config:\n        \"optimizer-less\",\n        // Plugin with custom configuration:\n        {\n            \"plugin\": \"optimizer-my-plugin\",\n            \"config\": { ... }\n        },\n        ...\n    ],\n    // The base output directory for generated bundles\n\t\"outputDir\": \"static\",\n\n\t// Optional URL prefix to prepend to relative bundle paths\n\t\"urlPrefix\": \"http://mycdn/static\",\n\n\t// If fingerprints are enabled then a shasum will be included in the URL.\n\t// This feature is used for cache busting.\n\t\"fingerprintsEnabled\": true,\n\n\t// If fingerprints are not enabled then the same output file would be\n\t// used for bundles that go into the head and bundles that go in the\n\t// body. Enabling this option will ensure that bundles have unique names\n\t// even if fingerprints are disabled.\n\t\"includeSlotNames\": false\n\n    // If \"minify\" is set to true then output CSS and JavaScript will run\n    // through a minification transform. (defaults to false)\n    \"minify\": true,\n\n    // If \"resolveCssUrls\" is set to try then URLs found in CSS files will be\n    // resolved and the original URLs will be replaced with the resolved URLs.\n    // (defaults to true)\n    \"resolveCssUrls\": true,\n\n    // If \"bundlingEnabled\" is set to true then dependencies will be concatenated\n    // together into one or more bundles. If set to false then each dependency\n    // will be written to a separate file. (defaults to true)\n    \"bundlingEnabled\": true,\n\n    // If you want consistent bundles across pages then those shared bundles\n    // can be specified below. If a page dependency is part of a shared\n    // bundle then the shared bundle will be added to the page (instead of\n    // adding the dependency to the page bundle).\n    \"bundles\": [\n        {\n            // Name of the bundle (used for determining the output filename)\n            \"name\": \"bundle1\",\n\n            // Set of dependencies to add to the bundle\n            \"dependencies\": [\n                \"./foo.js\",\n                \"./baz.js\"\n            ]\n        },\n        {\n            \"name\": \"bundle2\",\n            \"dependencies\": [\n                \"./style/*.css\",\n                \"require: **/*.js\"\n            ]\n        }\n    ]\n}\n```\n\n# Node.js-style Module Support\n\nThe Optimizer provides full support for transporting Node.js modules to the browser. If you write your modules in the standard Node.js way (i.e. using `require`, `module.exports` and `exports`) then the module will be able to be loaded on both the server and in the browser.\n\nThis functionality is offered by the core [optimizer-require](https://github.com/raptorjs/optimizer-require) plugin which introduces a new `require` dependency type. For example:\n\n```json\n[\n    \"require: ./path-to-some-module\"\n]\n```\n\nIf you want to include a module and have it run when loaded (i.e. self-executing) then you should use the `require-run` dependency type:\n\n```json\n[\n    \"require-run: ./main\"\n]\n```\n\nExamples of conditional requires:\n\n```json\n[\n    {\n        \"require-run\": \"./foo\",\n        \"if-flag\": \"bar\"\n    },\n    {\n        \"require\": \"./foo\",\n        \"if-flag\": \"bar\"\n    }\n]\n```\n\nIt's also possible to remap a require based on a flag:\n\n```json\n{\n    \"dependencies\": [\n        ...\n    ],\n    \"requireRemap\": [\n        {\n            \"from\": \"./foo.js\",\n            \"to\": \"./foo-mobile.js\",\n            \"if-flag\": \"mobile\"\n        }\n    ]\n}\n```\n\nThe [optimizer-require](https://github.com/raptorjs/optimizer-require) plugin will automatically scan the source to find all `require(path)` calls to determine which additional modules need to be included in the output bundles (done recursively). For a `require` to automatically be detected it must be in the form `require(\"<module-name>\")` or `require.resolve(\"<module-name>\")`.\n\nThe [optimizer-require](https://github.com/raptorjs/optimizer-require) plugin will automatically wrap all Node.js modules so that the psuedo globals (i.e. `require`, `module`, `exports`, `__filename` and `__dirname`) are made available to the module source code.\n\nThe `optimizer-require` plugin also supports [browserify shims](https://github.com/substack/node-browserify#compatibility) and [browserify transforms](https://github.com/substack/node-browserify/wiki/list-of-transforms).\n\nFor more details on how the Node.js modules are supported on the browser, please see the documentation for the [raptor-samples/optimizer-require](https://github.com/raptorjs/optimizer-require) plugin.\n\n# Available Plugins\n\nBelow is a list of plugins that are currently available:\n\n__Core plugins:__\n\n* [optimizer-require](https://github.com/raptorjs/optimizer-require): Node.js-style require for the browser (similar to [browserify](https://github.com/substack/node-browserify))\n* [optimizer-minify-css](https://github.com/raptorjs/optimizer-less): Minify CSS files using [sqwish](https://github.com/ded/sqwish)\n* [optimizer-minify-js](https://github.com/raptorjs/optimizer-minify-js): Minify JavaScript files using [uglify-js](https://www.npmjs.org/package/uglify-js)\n* [optimizer-resolve-css-urls](https://github.com/raptorjs/optimizer-resolve-css-urls): Replace each resource URL in a CSS file with an optimized resource URL\n\n__Third-party plugins__\n\n* [optimizer-dust](https://github.com/raptorjs/optimizer-dust): Compile [Dust](https://github.com/linkedin/dustjs) template files to JavaScript\n* [optimizer-handlebars](https://github.com/raptorjs/optimizer-handlebars): Compile [Handlebars](http://handlebarsjs.com/) template files to JavaScript\n* [optimizer-image](https://github.com/raptorjs/optimizer-image): Get image info (including URL, width and height) for any image on both the server and client\n* [optimizer-imagemin](https://github.com/raptorjs/optimizer-imagemin): Minify GIF, PNG, JPG and SVG images during optimization\n* [optimizer-jade](https://github.com/raptorjs/optimizer-jade): Compile [Jade](http://jade-lang.com/) templates to JavaScript\n* [optimizer-jsx](https://github.com/raptorjs/optimizer-jsx): Compile [JSX](http://facebook.github.io/react/docs/jsx-in-depth.html) files to JavaScript\n* [optimizer-less](https://github.com/raptorjs/optimizer-less): Compile [Less](http://lesscss.org/) files to CSS\n* [optimizer-lodash](https://github.com/raptorjs/optimizer-lodash): Compile [Lo-Dash](https://lodash.com/) files to JavaScript\n* [optimizer-marko](https://github.com/raptorjs/optimizer-require): Compile [Marko template](https://github.com/raptorjs/marko) files to JavaScript\n* [optimizer-sass](https://github.com/raptorjs/optimizer-sass): Compile [Sass](https://github.com/sass/node-sass) files to CSS\n* [optimizer-stylus](https://github.com/raptorjs/optimizer-stylus): Compile [Stylus](http://learnboost.github.io/stylus/) files to CSS\n\nTo use a third-party plugin, you must first install it using `npm install`. For example:\n\n```bash\nnpm install optimizer-less --save\n```\n\nIf you create your own plugin please send a Pull Request and it will show up above. Also, do not forget to tag your plugin with `optimizer-plugin` and `optimizer` in your `package.json` so that others can browse for it using [npm](https://www.npmjs.org/)\n\n# Extending the Optimizer\n\nOnly read below if you are building plugins or transforms to further enhance the `optimizer` module.\n\n## Custom Plugins\n\nA plugin can be used to change how the optimizer operates. This includes the following:\n\n* Register a custom dependency to support dependencies that compile to JS or CSS\n    * Examples:\n        * Register a dependency handler for \"less\" files to compiles Less to CSS\n        * Register a dependency handler for \"marko\" files to compiles Marko template files to JS\n* Register a custom bundle writer\n    * Examples:\n        * Upload bundles to a resource server that backs a CDN instead of writing them to disk\n* Register output transforms\n    * Examples:\n        * Add an output transform to minify JavaScript code\n        * Add an output transform to minify CSS code\n        * Add an output transform to remove `console.log` from JS code\n        * Add an output transform to resolve image URLs in CSS files\n* Configure the optimizer\n    * Examples:\n        * Allow a plugin to automatically configure the optimizer for production usage\n\nA plugin is simply a Node.js module that exports a function with the following signature:\n\n```javascript\n/**\n * A plugin for the Optimizer\n * @param  {optimizer/lib/PageOptimizer} optimizer An instance of a PageOptimizer that can be configured\n * @param  {Object} The plugin configuration provided by the user\n */\nmodule.exports = function(pageOptimizer, config) {\n    // Register dependency types:\n    pageOptimizer.dependencies.registerJavaScriptType('my-js-type', require('./dependency-my-js-type'));\n    pageOptimizer.dependencies.registerStyleSheetType('my-css-type', require('./dependency-my-css-type'));\n    pageOptimizer.dependencies.registerPackageType('my-package-type', require('./dependency-my-package-type'));\n\n    // Add an output transform\n    pageOptimizer.addTransform(require('./my-transform'));\n\n    // Register a custom Node.js/CommonJS module compiler for a custom filename extension\n    // var myModule = require('./hello.test');\n    pageOptimizer.dependencies.registerRequireExtension('test', function(path, context, callback) {\n        callback(null, \"exports.sayHello = function() { console.log('Hello!'); }\");\n    });\n};\n```\n\n## Custom Dependency Types\n\nThere are three types of dependencies that are supported:\n\n* __JavaScript dependency:__ Produces JavaScript code\n* __CSS dependency:__ Produces CSS code\n* __Package dependency:__ Produces a package of additional JavaScript and CSS dependencies\n\nEach of these dependencies is described in the next few sections. However, it is recommended to also check out the source code of [available plugins](#available-plugins) listed above (e.g. [optimizer-less](https://github.com/raptorjs/optimizer-less)).\n\n### Custom JavaScript Dependency Type\n\nIf you would like to introduce your own custom dependency types then you will need to have your plugin register a dependency handler. This is illustrated in the following sample code:\n\n```javascript\nmodule.exports = function myPlugin(optimizer, config) {\n    optimizer.dependencies.registerJavaScriptType(\n        'my-custom-type',\n        {\n            // Declare which properties can be passed to the dependency type\n            properties: {\n                'path': 'string'\n            },\n\n            // Validation checks and initialization based on properties:\n            init: function(context, callback) {\n                if (!this.path) {\n                    return callback(new Error('\"path\" is required'));\n                }\n\n                // NOTE: resolvePath can be used to resolve a provided relative path to a full path\n                this.path = this.resolvePath(this.path);\n                callback();\n            },\n\n            // Read the resource:\n            read: function(context, callback) {\n                var path = this.path;\n\n                fs.readFile(path, {encoding: 'utf8'}, function(err, src) {\n                    if (err) {\n                        return callback(err);\n                    }\n\n                    myCompiler.compile(src, callback);\n                });\n\n                // NOTE: A stream can also be returned\n            },\n\n            // getSourceFile is optional and is only used to determine the last modified time\n            // stamp and to give the output file a reasonable name when bundling is disabled\n            getSourceFile: function() {\n                return this.path;\n            }\n        });\n};\n```\n\nOnce registered, the above dependency can then be referenced from an `optimizer.json` as shown in the following code:\n\n```json\n{\n    \"dependencies\": [\n        \"my-custom-type: hello.file\"\n    ]\n}\n```\n\nIf a custom dependency supports more than just a `path` property, additional properties could be provided as shown in the following sample code:\n\n```json\n{\n    \"dependencies\": [\n        {\n            \"type\": \"my-custom-type\",\n            \"path\": \"hello.file\",\n            \"foo\": \"bar\",\n            \"hello\": true\n        }\n    ]\n}\n```\n\n\n### Custom CSS Dependency Type\n\nIf you would like to introduce your own custom dependency types then you will need to have your plugin register a dependency handler as shown in the following sample code:\n\n```javascript\nmodule.exports = function myPlugin(optimizer, config) {\n    optimizer.dependencies.registerStyleSheetType(\n        'my-custom-type',\n        handler);\n};\n```\n\nThe `handler` argument for a CSS dependency has the exact same interface as a handler for a JavaScript dependency (described earlier).\n\n### Custom Package Type\n\nA custom package dependency can be used to dynamically resolve additional dependencies at optimization time. The sample package dependency handler below illustrates how a package dependency can be used to automatically include every file in a directory as a dependency:\n\n```javascript\nvar fs = require('fs');\nvar path = require('path');\n\noptimizer.dependencies.registerPackageType('dir', {\n    properties: {\n        'path': 'string'\n    },\n\n    init: function(context, callback) {\n        var path = this.path;\n\n        if (!path) {\n            callback(new Error('\"path\" is required'));\n        }\n\n        this.path = path = this.resolvePath(path); // Convert the relative path to an absolute path\n\n        fs.stat(path, function(err, stat) {\n            if (err) {\n                return callback(err);\n            }\n\n            if (!stat.isDirectory()) {\n                return callback(new Error('Directory expected: ' + path));\n            }\n\n            callback();\n        });\n    },\n\n    getDependencies: function(context, callback) {\n        var dir = this.path;\n\n        fs.readdir(dir, function(err, filenames) {\n            if (err) {\n                return callback(err);\n            }\n\n            // Convert the filenames to full paths\n            var dependencies = filenames.map(function(filename) {\n                return path.join(dir, filename);\n            });\n\n            callback(null, dependencies);\n        });\n    },\n\n    getDir: function() {\n        // If the dependencies are associated with a directory then return that directory.\n        // Otherwise, return null\n        return this.path;\n    }\n});\n```\n\n## Custom Output Transforms\n\nRegistered output transforms are used to process bundles as they are written to disk. As an example, an output transform can be used to minify a JavaScript or CSS bundle. Another example is that an output transform may be used to remove `console.log` statements from output JavaScript code. Transforms should be registered by a plugin using the `pageOptimizer.addTransform(transform)` method.\n\nAs an example, the following unhelpful transform will convert all JavaScript source code to upper case:\n\n```javascript\nmodule.exports = function (pageOptimizer, pluginConfig) {\n    pageOptimizer.addTransform({\n\n        // Only apply to JavaScript code\n        contentType: 'js', //  'css' is the other option\n\n        // Give your module a friendly name (helpful for debugging in case something goes wrong in your code)\n        name: module.id,\n\n        // If stream is set to false then a String will be provided. Otherwise, a readable stream will be provided\n        stream: false,\n\n        // Do the magic:\n        transform: function(code, contentType, dependency, bundle) {\n            return code.toUpperCase();\n        }\n    });\n};\n```\n\nBelow is the streaming version of the same transform:\n\n```javascript\nvar through = require('through');\n\nmodule.exports = function (pageOptimizer, pluginConfig) {\n    pageOptimizer.addTransform({\n\n        // Only apply to JavaScript code\n        contentType: 'js', //  'css' is the other option\n\n        // Give your module a friendly name (helpful for debugging in case something goes wrong in your code)\n        name: module.id,\n\n        stream: true, // We want the code to be streamed to us\n\n        // Do the magic:\n        transform: function(inStream, contentType, dependency, bundle) {\n            return inStream.pipe(through(\n                function write(data) {\n                    this.queue(data.toUpperCase());\n                }));\n        }\n    });\n};\n```\n\n# Sample Projects\n\n* [raptor-samples/optimizer-cli](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-cli): Demonstrates the command-line interface.\n* [raptor-samples/optimizer-config](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-config): Demonstrates the usage of a JSON config file.\n* [raptor-samples/optimizer-async](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-async): Demonstrates asynchronous/lazy dependency loading.\n* [raptor-samples/optimizer-js-api](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-js-api): Demonstrates how to use JavaScript API to optimize a page and inject the resulting head and body markup into a page.\n* [raptor-samples/optimizer-taglib](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-taglib): Demonstrates the use of the optimizer taglib for Marko.\n* [raptor-samples/optimizer-templates](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-templates): Demonstrates the use of rendering the same templates on both the server and the client.\n* [raptor-samples/optimizer-express](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-express): Demonstrates using the Optimizer at runtime as part of an Express server app.\n* [raptor-samples/optimizer-code-splitting](https://github.com/raptorjs/raptor-samples/tree/master/optimizer-code-splitting): Demonstrates splitting out dependencies that are common across pages into a separate bundle.\n\n# Discuss\n\nPlease post questions or comments on the [RaptorJS Google Groups Discussion Forum](http://groups.google.com/group/raptorjs).\n\n# Maintainers\n\n* [Patrick Steele-Idem](https://github.com/patrick-steele-idem) (Twitter: [@psteeleidem](http://twitter.com/psteeleidem))\n* [Phillip Gates-Idem](https://github.com/philidem/) (Twitter: [@philidem](https://twitter.com/philidem))\n\n# Contributors\n\n* Vinod Kumar (Twitter: [@vinodl](https://twitter.com/vinodl))\n    - [gulp-optimizer](https://github.com/raptorjs/gulp-optimizer)\n    - [optimizer-jsx](https://github.com/raptorjs/optimizer-jsx)\n\n# Contribute\n\nPull Requests welcome. Please submit Github issues for any feature enhancements, bugs or documentation problems.\n\n# License\n\nApache License v2.0\n",
  "readmeFilename": "README.md",
  "bugs": {
    "url": "https://github.com/raptorjs/optimizer/issues"
  },
  "homepage": "https://github.com/raptorjs/optimizer",
  "_id": "optimizer@1.7.0",
  "_from": "optimizer@1.7"
}
